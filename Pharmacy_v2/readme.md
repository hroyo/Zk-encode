# ZK Diseasechecker ZoKrates for Pharmacy

Follow these steps in https://zokrates.github.io/gettingstarted.html

```
git clone https://github.com/ZoKrates/ZoKrates
cd ZoKrates
export ZOKRATES_STDLIB=$PWD/zokrates_stdlib/stdlib
cargo build -p zokrates_cli --release
cd target/release
```

To be able to run zokrates, I had to add the following paths into the startup script:

open file with `nano ~/.bashrc`

Then add 

```
export ZOKRATES_STDLIB=/mnt/c/Users/chine/EncodeBootcamp/ZKBootcamp/Zokrates/zokrates/zokrates_stdlib/stdlib
export PATH=$PATH:/mnt/c/Users/chine/EncodeBootcamp/ZKBootcamp/Zokrates/zokrates/target/release
```

then run 

`source ~/.bashrc`

Create the folder `Pharmacy_v2`

Place `pharmacy.zok` inside with the following code:

```
def main(private field secret, field address, private field[5] arr, field target)  {
    assert(secret == address);
    bool mut found = false;
    for u32 i in 0..5 {
        found = if (arr[i] == target) {true} else {found};
    }
    assert(found);
}

```

code checks if `target` (number representing some medical condition) is contained in an array `private field[5] arr`. The array `private field[5] arr` is the whole medical record.

For example `1234` can represent "Asthma" and `5678` can represent "Diabetic"

`secret` and `address` are the wallet address for which the proof is created. This assertion makes sure that only this wallet address can use this proof to purchase the medicine. The proof would be false for any other wallet address. Note that a decimal representation of the address (which is in hex) is required.

In our example, the wallet address for which the proof is created is `0x974bfc05c4b51d4b9d84131a9a870eeccfb77121` which is `863752116543225290167644995281522894808962003233` in decimal. ZoKrates does not understand hex.

run these steps:

```
# compile
zokrates compile -i pharmacy.zok
# perform the setup phase
zokrates setup
# execute the program
zokrates compute-witness -a 863752116543225290167644995281522894808962003233 863752116543225290167644995281522894808962003233 22 2312 1234 4444 3333 1234
# generate a proof of computation
zokrates generate-proof
# export a solidity verifier
zokrates export-verifier
```

The proof generated by `zokrates generate-proof` is `proof.json` and is renamed to `proof_1234.json`

In this case, the second secret `private field[5] arr` is `22 2312 1234 4444 3333` (representing the whole medical record of medical conditions), the last number `1234` is the input we want to check in the array (i.e. we want to check if Asthma is contained in the medical record), a verifier contract `verifier.sol` is generated.

If we run

`zokrates compute-witness -a zokrates compute-witness -a 863752116543225290167644995281522894808962003233 863752116543225290167644995281522894808962003233 22 2312 1234 4444 3333 5678
`, i.e. we check if "Diabetic" is in the medical record, this would fail.

we create a proof that `0x7d77b0d031B4B8C0444eaE9b778479bbFcd6721a` (decimal representation `716293037638731926465907464220363273042486784538`) has medical condition `5678`, i.e., "Diabetic"

```
zokrates compute-witness -a 716293037638731926465907464220363273042486784538 716293037638731926465907464220363273042486784538 34 5555 6666 5678 888 5678
zokrates generate-proof
```

The proof generated by `zokrates generate-proof` is `proof.json` and is renamed to `proof_5678.json`

The `verifier.sol` contract is deployed on Sepolia `0xD3f2Cc3e0214c8ae9c32722f50aC442af36a135a` https://sepolia.etherscan.io/address/0xd3f2cc3e0214c8ae9c32722f50ac442af36a135a

The `verifyTx` function takes as input the proof and and array `uint[2]` which is composed of the integer representation of the address and the medical condition `1234` (`0x4d2` in hex) or `5678` (`0x162e` in hex), see also the inputs array in `proof_1234.json` and `proof_5678.json`.

The point of having these two inputs is that the proof should be only valid for the provided inputs which is the pair wallet address/medical condition. Any other random wallet address should not be able to use the sane proof to purchase the medicine.

`pharmacy.sol` is the contract for buying medicine, deployed on Sepolia `0x6a651566A60F08e395068E0C20b29d0e95a5f875`:  https://sepolia.etherscan.io/address/0x6a651566A60F08e395068E0C20b29d0e95a5f875

function `buyMedicineA` is for buying medicine A. It requires a payment of 0.001 ETH (1e15 Wei) and a proof for the medical condition `1234`.

function `buyMedicineB` is for buying medicine B. It requires a payment of 0.002 ETH (2e15 Wei) and a proof for the medical condition `5678`.

Wallet address `0x974BFC05C4B51d4B9d84131A9A870EEcCFB77121` uses proof 

```
[[0x27045bd3cf96298d09188bf83231adf5b13236e8002d9d2e864513dada6ab47d, 0x25f0bfe8e6401d9a0498ecec861a70ba32b11dac1a807722dfa615fe17887e83],             [[0x0059eceab5e351f4e5b2c0a628eda4edef5ede5cdce2a900edde56da881a0fc8, 0x16dc8f37ff35b12973538dba8915afa617a4a4d040240ef6ee5abf7aaf0dfe32],
[0x128d78f20a7b8650fd5e38b6b5a0808a517e5f2b7237f467fd0bcc2d38c69860, 0x0e16e2df1a65030bb88fc84e9862b12a0707dd89c7faf73bd928450a07c62c69]],
[0x19b56485bc972765ebd2114539533508c1efca42943b247c584711c208843ec5, 0x026219f3dc394f6f587cbc1056fe765d7a6bfc64cdadd00e35a9614bab217dcb]]
```

to call the function `buyMedicineA`, with value = `1000000000000000 Wei`.

Successful transaction:

https://sepolia.etherscan.io/tx/0x83db31ceb95ef786ed6c900225d80d93ffa70b64d93462f2e3491038eb441385

See Remix

![image](https://github.com/BigBangInfinity/Encode_ZKBootcamp_Homework/assets/37957341/de198442-dc13-4d14-bda8-1816875c18f9)



Wallet address `0x6a651566A60F08e395068E0C20b29d0e95a5f875` uses proof 

```
[[0x2280f21d84c13bfb08878d7a57c83fe6cef1e889ddd3c6d2f735b85089c60f6d, 0x0caee1e6b14d8083d0235691a5691ebea83a8ca7192fce03cc7232b6c1a8b46c],             [[0x167f034a3eedb5f7e9d0ba82f28214d28db8c8d48e4ed0ec65fa98dadc9497c3, 0x268d6e09802b324a3362597e4c95b840e92f459c1a8fe5e94b174da1406bbd65],
[0x02a5950e4a19d50b5a204be8c6cf18a9a9231b9b9ddc8cdd9a55574b27cf1487, 0x2c4a32b08e951b15a2c0c210c8e35f2296aebd298fb62e5a1c2da62dd210502a]],
[0x0890362478dc373f58e9f1760b9ec9841c6065a88e0141b4a792c753e39d9ede, 0x166d6f96145c8b3fb23742bc4b67b54e345b74391b61b29d2d7bc5381b0da7d6]]
```

to call the function `buyMedicineB`, with value = `2000000000000000 Wei`.

Successful transaction:

https://sepolia.etherscan.io/tx/0xfdd8829964a7a745af6755b80f1d13f3698eddfd2c27845f03e228828b90b0f6

The owner (deployer) can call the `withdraw` function to withdraw the ETH.
